language: python
sudo: required
python:
- "2.7"
install:
- pip install -r requirements.txt
- pip install awscli
script:
- python -m pytest -v

services:
- docker

jobs:
  include:
    - stage: deploy to dockerhub
      script:
       - docker login -u $DOCKER_USER -p $DOCKER_PASS
       - docker build -f Dockerfile -t $TRAVIS_REPO_SLUG:$TRAVIS_BRANCH .
       - docker run --rm -p 5000:5000 -d $TRAVIS_REPO_SLUG:$TRAVIS_BRANCH
       - docker ps | grep -q "$TRAVIS_REPO_SLUG:$TRAVIS_BRANCH"
       - sleep 2
       - curl "localhost:5000"
       - sleep 3
       - "curl -X GET localhost:5000"
       - docker push $TRAVIS_REPO_SLUG

    - stage: deploy to s3 and codedeploy app
      deploy:
      - provider: s3
        access_key_id: $AWS_ACCESS_KEY
        secret_access_key: $AWS_SECRET_KEY
        local_dir: pythontest
        skip_cleanup: true
        on: &2
          branch: master
        bucket: travisdeploy-s3
        region: us-east-2

      - provider: codedeploy
        access_key_id: $AWS_ACCESS_KEY
        secret_access_key: $AWS_SECRET_KEY
        bucket: travisdeploy-s3
        file_exists_behavior: overwrite
        key: latest.zip
        bundle_type: zip
        application: travisdeploy-app
        deployment_group: travisdeploy-group
        wait_until_deployed: true
        region: us-east-2
        on: *2
      script:
        - zip -r latest *
        - mkdir -p pythontest
        - mv latest.zip pythontest/latest.zip
